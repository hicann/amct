# save\_compressed\_retrain\_model<a name="ZH-CN_TOPIC_0000002517028750"></a>

## 产品支持情况<a name="section329012164010"></a>

<a name="zh-cn_topic_0000002517188752_table38301303189"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000002517188752_row20831180131817"><th class="cellrowborder" valign="top" width="47.92%" id="mcps1.1.3.1.1"><p id="zh-cn_topic_0000002517188752_p1883113061818"><a name="zh-cn_topic_0000002517188752_p1883113061818"></a><a name="zh-cn_topic_0000002517188752_p1883113061818"></a><span id="zh-cn_topic_0000002517188752_ph20833205312295"><a name="zh-cn_topic_0000002517188752_ph20833205312295"></a><a name="zh-cn_topic_0000002517188752_ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="left" valign="top" width="52.080000000000005%" id="mcps1.1.3.1.2"><p id="zh-cn_topic_0000002517188752_p783113012187"><a name="zh-cn_topic_0000002517188752_p783113012187"></a><a name="zh-cn_topic_0000002517188752_p783113012187"></a>是否支持</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000002517188752_row574891710101"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p177491117171015"><a name="zh-cn_topic_0000002517188752_p177491117171015"></a><a name="zh-cn_topic_0000002517188752_p177491117171015"></a><span id="zh-cn_topic_0000002517188752_ph2272194216543"><a name="zh-cn_topic_0000002517188752_ph2272194216543"></a><a name="zh-cn_topic_0000002517188752_ph2272194216543"></a>Ascend 950PR/Ascend 950DT</span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul1367712433612"></a><a name="zh-cn_topic_0000002517188752_ul1367712433612"></a><ul id="zh-cn_topic_0000002517188752_ul1367712433612"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul5366163611332"></a><a name="zh-cn_topic_0000002517188752_ul5366163611332"></a><ul id="zh-cn_topic_0000002517188752_ul5366163611332"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：x</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002517188752_row220181016240"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p48327011813"><a name="zh-cn_topic_0000002517188752_p48327011813"></a><a name="zh-cn_topic_0000002517188752_p48327011813"></a><span id="zh-cn_topic_0000002517188752_ph583230201815"><a name="zh-cn_topic_0000002517188752_ph583230201815"></a><a name="zh-cn_topic_0000002517188752_ph583230201815"></a><term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul66191179379"></a><a name="zh-cn_topic_0000002517188752_ul66191179379"></a><ul id="zh-cn_topic_0000002517188752_ul66191179379"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul7274174217362"></a><a name="zh-cn_topic_0000002517188752_ul7274174217362"></a><ul id="zh-cn_topic_0000002517188752_ul7274174217362"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：√</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002517188752_row173226882415"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p14832120181815"><a name="zh-cn_topic_0000002517188752_p14832120181815"></a><a name="zh-cn_topic_0000002517188752_p14832120181815"></a><span id="zh-cn_topic_0000002517188752_ph1483216010188"><a name="zh-cn_topic_0000002517188752_ph1483216010188"></a><a name="zh-cn_topic_0000002517188752_ph1483216010188"></a><term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"></a>Atlas A2 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul19623147153713"></a><a name="zh-cn_topic_0000002517188752_ul19623147153713"></a><ul id="zh-cn_topic_0000002517188752_ul19623147153713"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul0992647173610"></a><a name="zh-cn_topic_0000002517188752_ul0992647173610"></a><ul id="zh-cn_topic_0000002517188752_ul0992647173610"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：√</li></ul>
</td>
</tr>
</tbody>
</table>

**注：特性中标记“x”的产品，调用接口不会报错，但是获取不到性能收益。**

## 功能说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_section15406195619561"></a>

静态组合压缩接口，根据用户最终的重训练好的模型，生成最终静态组合压缩精度仿真模型以及部署模型。

## 函数原型<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section428121323411"></a>

```python
save_compressed_retrain_model(model, record_file, save_path, input_data, input_names=None, output_names=None, dynamic_axes=None)
```

## 参数说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section795991810344"></a>

<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_table438764393513"></a>
<table><thead align="left"><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row53871743113510"><th class="cellrowborder" valign="top" width="11.16%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a>参数名</p>
</th>
<th class="cellrowborder" valign="top" width="7.95%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a>输入/输出</p>
</th>
<th class="cellrowborder" valign="top" width="80.89%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a>说明</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row2038874343514"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p12108101818814"><a name="p12108101818814"></a><a name="p12108101818814"></a>model</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p13482131324113"><a name="p13482131324113"></a><a name="p13482131324113"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p20897173423615"><a name="p20897173423615"></a><a name="p20897173423615"></a>含义：已经进行静态组合压缩后的PyTorch模型。</p>
<p id="p9607425115012"><a name="p9607425115012"></a><a name="p9607425115012"></a>数据类型：torch.nn.Module</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row16254133823918"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p810815183816"><a name="p810815183816"></a><a name="p810815183816"></a>record_file</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p175011134411"><a name="p175011134411"></a><a name="p175011134411"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p145771141123612"><a name="p145771141123612"></a><a name="p145771141123612"></a>含义：稀疏和量化因子记录文件路径及名称。</p>
<p id="p17619162585010"><a name="p17619162585010"></a><a name="p17619162585010"></a>数据类型：string</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row2997141123911"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p1110815181988"><a name="p1110815181988"></a><a name="p1110815181988"></a>save_path</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p141811497475"><a name="p141811497475"></a><a name="p141811497475"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p6973842133613"><a name="p6973842133613"></a><a name="p6973842133613"></a>含义：保存压缩模型的路径。</p>
<p id="p3624142513506"><a name="p3624142513506"></a><a name="p3624142513506"></a>数据类型：string</p>
</td>
</tr>
<tr id="row51780230810"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p017819231680"><a name="p017819231680"></a><a name="p017819231680"></a>input_data</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p61604531884"><a name="p61604531884"></a><a name="p61604531884"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p10320204414363"><a name="p10320204414363"></a><a name="p10320204414363"></a>含义：模型的输入数据。一个<span>torch.tensor</span><span>会被等价为tuple（torch.tensor）</span>。</p>
<p id="p195118591985"><a name="p195118591985"></a><a name="p195118591985"></a>数据类型：tuple</p>
</td>
</tr>
<tr id="row161899281186"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p1810815183816"><a name="p1810815183816"></a><a name="p1810815183816"></a>input_names</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p1817012537814"><a name="p1817012537814"></a><a name="p1817012537814"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p4611124553611"><a name="p4611124553611"></a><a name="p4611124553611"></a>含义：模型的输入的名称，用于保存的量化onnx模型中显示。</p>
<p id="p78101226135"><a name="p78101226135"></a><a name="p78101226135"></a>默认值：None</p>
<p id="p1451615598811"><a name="p1451615598811"></a><a name="p1451615598811"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row9693030189"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p18108718889"><a name="p18108718889"></a><a name="p18108718889"></a>output_names</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p91791053686"><a name="p91791053686"></a><a name="p91791053686"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p915214753618"><a name="p915214753618"></a><a name="p915214753618"></a>含义：模型的输出的名称，用于保存的量化onnx模型中显示。</p>
<p id="p1631083319133"><a name="p1631083319133"></a><a name="p1631083319133"></a>默认值：None</p>
<p id="p115239594818"><a name="p115239594818"></a><a name="p115239594818"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row127516261687"><td class="cellrowborder" valign="top" width="11.16%" headers="mcps1.1.4.1.1 "><p id="p5275326787"><a name="p5275326787"></a><a name="p5275326787"></a>dynamic_axes</p>
</td>
<td class="cellrowborder" valign="top" width="7.95%" headers="mcps1.1.4.1.2 "><p id="p10185135316819"><a name="p10185135316819"></a><a name="p10185135316819"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="80.89%" headers="mcps1.1.4.1.3 "><p id="p0969164883618"><a name="p0969164883618"></a><a name="p0969164883618"></a>含义：对模型输入输出动态轴的指定，例如对于输入inputs（NCHW），N、H、W为不确定大小，输出outputs（NL），N为不确定大小，则指定形式为：</p>
<p id="p13121617183715"><a name="p13121617183715"></a><a name="p13121617183715"></a>{ "inputs": [0,2,3], "outputs": [0]}，其中0,2,3分别表示N，H，W所在位置的索引。</p>
<p id="p1460565011316"><a name="p1460565011316"></a><a name="p1460565011316"></a>默认值：None</p>
<p id="p460555021319"><a name="p460555021319"></a><a name="p460555021319"></a>数据类型：dict&lt;string, dict&lt;python:int, string&gt;&gt; or dict&lt;string, list(int)&gt;</p>
</td>
</tr>
</tbody>
</table>

## 返回值说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section293415513458"></a>

无

## 约束说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_section1443392021419"></a>

若模型只做了稀疏（没有做量化），则通过该接口生成的两个文件为直接使用PyTorch导出的onnx文件，文件内容一致，文件名称分别包括deploy和fake\_quant关键字。

## 调用示例<a name="zh-cn_topic_0254208276_section213682915617"></a>

```python
import amct_pytorch as amct
# 建立待压缩的网络图结构
model = build_model()

# create compressed model

#训练retrain模型，训练量化因子
train(compressed_retrain_model)
infer(compressed_retrain_model)

input_data = tuple([torch.randn(input_shape)])
save_path = os.path.join(OUTPUTS_DIR, 'custom_name')
record_file = os.path.join(TMP, 'compressed_record.txt')

#插入保存组合压缩模型的API，转换成ONNX文件
amct.save_compressed_retrain_model(
     compressed_retrain_model,
     record_file,
     save_path,
     input_data,
     input_names=['input'],
     output_names=['output'],
     dynamic_axes={'input':{0:'batch_size'}, 'output':{0:'batch_size'}})
```

落盘文件说明：

-   精度仿真模型文件：ONNX格式的模型文件，模型名中包含fake\_quant，可以在ONNX Runtime环境进行精度仿真。
-   部署模型文件：ONNX格式的模型文件，模型名中包含deploy，经过ATC转换工具转换后可部署到AI处理器。
-   （可选）\*.external文件，包括\*deploy.external和\*fakequant.external：

    只有保存的精度仿真模型以及部署模型文件大小\>=2GB才会生成该类文件，且与压缩后的\*.onnx模型文件生成在同级目录，用于保存Tensor中的数据，每个Tensor数据单独保存一份\*.external文件，文件名与Tensor相同，例如_conv1.weight_\_deploy.external和_conv1.weight_\_fakequant.external。

    后续通过ATC工具加载压缩后的\*.onnx部署模型文件进行模型转换时，会自动读取同级目录下\*.external文件中的Tensor数据。

重新执行静态组合压缩时，该接口输出的上述文件将会被覆盖。

