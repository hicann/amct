# restore\_compressed\_retrain\_model<a name="ZH-CN_TOPIC_0000002548668611"></a>

## 产品支持情况<a name="section329012164010"></a>

<a name="zh-cn_topic_0000002517188752_table38301303189"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000002517188752_row20831180131817"><th class="cellrowborder" valign="top" width="47.92%" id="mcps1.1.3.1.1"><p id="zh-cn_topic_0000002517188752_p1883113061818"><a name="zh-cn_topic_0000002517188752_p1883113061818"></a><a name="zh-cn_topic_0000002517188752_p1883113061818"></a><span id="zh-cn_topic_0000002517188752_ph20833205312295"><a name="zh-cn_topic_0000002517188752_ph20833205312295"></a><a name="zh-cn_topic_0000002517188752_ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="left" valign="top" width="52.080000000000005%" id="mcps1.1.3.1.2"><p id="zh-cn_topic_0000002517188752_p783113012187"><a name="zh-cn_topic_0000002517188752_p783113012187"></a><a name="zh-cn_topic_0000002517188752_p783113012187"></a>是否支持</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000002517188752_row574891710101"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p177491117171015"><a name="zh-cn_topic_0000002517188752_p177491117171015"></a><a name="zh-cn_topic_0000002517188752_p177491117171015"></a><span id="zh-cn_topic_0000002517188752_ph2272194216543"><a name="zh-cn_topic_0000002517188752_ph2272194216543"></a><a name="zh-cn_topic_0000002517188752_ph2272194216543"></a>Ascend 950PR/Ascend 950DT</span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul1367712433612"></a><a name="zh-cn_topic_0000002517188752_ul1367712433612"></a><ul id="zh-cn_topic_0000002517188752_ul1367712433612"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul5366163611332"></a><a name="zh-cn_topic_0000002517188752_ul5366163611332"></a><ul id="zh-cn_topic_0000002517188752_ul5366163611332"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：x</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002517188752_row220181016240"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p48327011813"><a name="zh-cn_topic_0000002517188752_p48327011813"></a><a name="zh-cn_topic_0000002517188752_p48327011813"></a><span id="zh-cn_topic_0000002517188752_ph583230201815"><a name="zh-cn_topic_0000002517188752_ph583230201815"></a><a name="zh-cn_topic_0000002517188752_ph583230201815"></a><term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term131434243115"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul66191179379"></a><a name="zh-cn_topic_0000002517188752_ul66191179379"></a><ul id="zh-cn_topic_0000002517188752_ul66191179379"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul7274174217362"></a><a name="zh-cn_topic_0000002517188752_ul7274174217362"></a><ul id="zh-cn_topic_0000002517188752_ul7274174217362"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：√</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002517188752_row173226882415"><td class="cellrowborder" valign="top" width="47.92%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517188752_p14832120181815"><a name="zh-cn_topic_0000002517188752_p14832120181815"></a><a name="zh-cn_topic_0000002517188752_p14832120181815"></a><span id="zh-cn_topic_0000002517188752_ph1483216010188"><a name="zh-cn_topic_0000002517188752_ph1483216010188"></a><a name="zh-cn_topic_0000002517188752_ph1483216010188"></a><term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"></a><a name="zh-cn_topic_0000002517188752_zh-cn_topic_0000001312391781_term184716139811"></a>Atlas A2 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="52.080000000000005%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002517188752_ul19623147153713"></a><a name="zh-cn_topic_0000002517188752_ul19623147153713"></a><ul id="zh-cn_topic_0000002517188752_ul19623147153713"><li>量化感知训练：<a name="zh-cn_topic_0000002517188752_ul0992647173610"></a><a name="zh-cn_topic_0000002517188752_ul0992647173610"></a><ul id="zh-cn_topic_0000002517188752_ul0992647173610"><li>INT8量化：√</li><li>INT4量化：x</li></ul>
</li><li>通道稀疏：√</li><li>4选2结构化稀疏：√</li></ul>
</td>
</tr>
</tbody>
</table>

**注：特性中标记“x”的产品，调用接口不会报错，但是获取不到性能收益。**

## 功能说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_section15406195619561"></a>

静态组合压缩训练接口，将输入的待静态组合压缩的模型按照给定的组合压缩配置文件和record记录文件进行压缩处理（先稀疏后量化），加载保存的权重。将传入的模型按照给定record\_file中稀疏记录进行稀疏，后对模型插入量化相关的算子（数据和权重的量化感知训练层以及searchN的层）。加载训练过程中保存的checkpoint权重参数，返回修改后的torch.nn.Module模型。

## 函数原型<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section428121323411"></a>

```python
compressed_retrain_model = restore_compressed_retrain_model(model, input_data, config_defination, record_file, pth_file, state_dict_name=None)
```

## 参数说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section795991810344"></a>

<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_table438764393513"></a>
<table><thead align="left"><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row53871743113510"><th class="cellrowborder" valign="top" width="12.950000000000001%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a>参数名</p>
</th>
<th class="cellrowborder" valign="top" width="5.949999999999999%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a>输入/输出</p>
</th>
<th class="cellrowborder" valign="top" width="81.10000000000001%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a>说明</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row2038874343514"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p202571341976"><a name="p202571341976"></a><a name="p202571341976"></a>model</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p168681026184710"><a name="p168681026184710"></a><a name="p168681026184710"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p128631143163419"><a name="p128631143163419"></a><a name="p128631143163419"></a>含义：Torch的model。</p>
<p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p11225740182619"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p11225740182619"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p11225740182619"></a>数据类型：torch.nn.Module</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row21251438195"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p16256941670"><a name="p16256941670"></a><a name="p16256941670"></a>input_data</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p13482131324113"><a name="p13482131324113"></a><a name="p13482131324113"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p6795104910343"><a name="p6795104910343"></a><a name="p6795104910343"></a>含义：模型的输入数据。一个torch.tensor会被等价为tuple(torch.tensor)。</p>
<p id="p12421175414419"><a name="p12421175414419"></a><a name="p12421175414419"></a>数据类型：tuple</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row16254133823918"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p325314411272"><a name="p325314411272"></a><a name="p325314411272"></a>config_defination</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p18491181320411"><a name="p18491181320411"></a><a name="p18491181320411"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p1896615017345"><a name="p1896615017345"></a><a name="p1896615017345"></a>含义：静态组合压缩简易配置文件。</p>
<p id="p827435611439"><a name="p827435611439"></a><a name="p827435611439"></a>基于retrain_config_pytorch.proto文件生成的简易配置文件<em id="i497145210579"><a name="i497145210579"></a><a name="i497145210579"></a>compressed</em>.cfg，*.proto文件所在路径为：<em id="i12274856104314"><a name="i12274856104314"></a><a name="i12274856104314"></a><span id="ph244511481409"><a name="ph244511481409"></a><a name="ph244511481409"></a>AMCT</span>安装目录</em>/amct_pytorch/proto/。*.proto文件参数解释以及生成的<em id="i2675712185810"><a name="i2675712185810"></a><a name="i2675712185810"></a>compressed</em>.cfg简易量化配置文件样例请参见<a href="../context/量化感知训练简易配置文件.md">量化感知训练简易配置文件</a>。</p>
<p id="p64303542418"><a name="p64303542418"></a><a name="p64303542418"></a>数据类型：string</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row2997141123911"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p524715411979"><a name="p524715411979"></a><a name="p524715411979"></a>record_file</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p175011134411"><a name="p175011134411"></a><a name="p175011134411"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p945375373414"><a name="p945375373414"></a><a name="p945375373414"></a>含义：已经记录稀疏和量化因子的文件。</p>
<p id="p1543455424113"><a name="p1543455424113"></a><a name="p1543455424113"></a>数据类型：string</p>
</td>
</tr>
<tr id="row198861208188"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p98861007189"><a name="p98861007189"></a><a name="p98861007189"></a>pth_file</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p11886100141815"><a name="p11886100141815"></a><a name="p11886100141815"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p97281755163418"><a name="p97281755163418"></a><a name="p97281755163418"></a>含义：训练过程中保存的权重文件。</p>
<p id="p2886100161815"><a name="p2886100161815"></a><a name="p2886100161815"></a>数据类型：string</p>
</td>
</tr>
<tr id="row573523151818"><td class="cellrowborder" valign="top" width="12.950000000000001%" headers="mcps1.1.4.1.1 "><p id="p87352315184"><a name="p87352315184"></a><a name="p87352315184"></a>state_dict_name</p>
</td>
<td class="cellrowborder" valign="top" width="5.949999999999999%" headers="mcps1.1.4.1.2 "><p id="p107352035189"><a name="p107352035189"></a><a name="p107352035189"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="81.10000000000001%" headers="mcps1.1.4.1.3 "><p id="p18239165793412"><a name="p18239165793412"></a><a name="p18239165793412"></a>含义：权重文件中权重对应的键值。</p>
<p id="p7244115232112"><a name="p7244115232112"></a><a name="p7244115232112"></a>默认值：None</p>
<p id="p187185713210"><a name="p187185713210"></a><a name="p187185713210"></a>数据类型：string</p>
</td>
</tr>
</tbody>
</table>


## 返回值说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section293415513458"></a>

根据record\_file中稀疏关系进行稀疏后的，且插入量化相关层的，已加载权重文件的torch.nn.Module静态组合压缩训练模型。

## 约束说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_section1443392021419"></a>

组合压缩配置文件至少存在一个配置：稀疏配置或者量化配置。

## 调用示例<a name="zh-cn_topic_0254208276_section213682915617"></a>

```python
import amct_pytorch as amct
# 建立待进行组合压缩的网络图结构
model = build_model()
input_data = tuple(torch.randn(input_shape))
save_pth_path = /your/path/to/save/tmp.pth

record_file = os.path.join(TMP, 'compressed_record.txt')
config_defination = './compressed_cfg.cfg'

torch.save({'state_dict': model.state_dict()}, save_pth_path)
compressed_retrain_model = amct.restore_compressed_retrain_model(
                                model,
                                input_data,
                                config_defination,
                                record_file,
                                save_pth_path,
                                'state_dict')
```

