# save\_quant\_retrain\_model<a name="ZH-CN_TOPIC_0000002548788575"></a>

## 产品支持情况<a name="section185612964420"></a>

<a name="zh-cn_topic_0000002517028880_table38301303189"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000002517028880_row20831180131817"><th class="cellrowborder" valign="top" width="57.95%" id="mcps1.1.3.1.1"><p id="zh-cn_topic_0000002517028880_p1883113061818"><a name="zh-cn_topic_0000002517028880_p1883113061818"></a><a name="zh-cn_topic_0000002517028880_p1883113061818"></a><span id="zh-cn_topic_0000002517028880_ph20833205312295"><a name="zh-cn_topic_0000002517028880_ph20833205312295"></a><a name="zh-cn_topic_0000002517028880_ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="center" valign="top" width="42.05%" id="mcps1.1.3.1.2"><p id="zh-cn_topic_0000002517028880_p783113012187"><a name="zh-cn_topic_0000002517028880_p783113012187"></a><a name="zh-cn_topic_0000002517028880_p783113012187"></a>是否支持</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000002517028880_row574891710101"><td class="cellrowborder" valign="top" width="57.95%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517028880_p177491117171015"><a name="zh-cn_topic_0000002517028880_p177491117171015"></a><a name="zh-cn_topic_0000002517028880_p177491117171015"></a><span id="zh-cn_topic_0000002517028880_ph2272194216543"><a name="zh-cn_topic_0000002517028880_ph2272194216543"></a><a name="zh-cn_topic_0000002517028880_ph2272194216543"></a>Ascend 950PR/Ascend 950DT</span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42.05%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p14226338117"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p14226338117"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p14226338117"></a>√</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002517028880_row220181016240"><td class="cellrowborder" valign="top" width="57.95%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517028880_p48327011813"><a name="zh-cn_topic_0000002517028880_p48327011813"></a><a name="zh-cn_topic_0000002517028880_p48327011813"></a><span id="zh-cn_topic_0000002517028880_ph583230201815"><a name="zh-cn_topic_0000002517028880_ph583230201815"></a><a name="zh-cn_topic_0000002517028880_ph583230201815"></a><term id="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term131434243115"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term131434243115"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term131434243115"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42.05%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p108715341013"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p108715341013"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p108715341013"></a>√</p>
</td>
</tr>
<tr id="zh-cn_topic_0000002517028880_row173226882415"><td class="cellrowborder" valign="top" width="57.95%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002517028880_p14832120181815"><a name="zh-cn_topic_0000002517028880_p14832120181815"></a><a name="zh-cn_topic_0000002517028880_p14832120181815"></a><span id="zh-cn_topic_0000002517028880_ph1483216010188"><a name="zh-cn_topic_0000002517028880_ph1483216010188"></a><a name="zh-cn_topic_0000002517028880_ph1483216010188"></a><term id="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term184716139811"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term184716139811"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000001312391781_term184716139811"></a>Atlas A2 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="center" valign="top" width="42.05%" headers="mcps1.1.3.1.2 "><p id="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p19948143911820"><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p19948143911820"></a><a name="zh-cn_topic_0000002517028880_zh-cn_topic_0000002517188794_p19948143911820"></a>√</p>
</td>
</tr>
</tbody>
</table>

## 功能说明<a name="zh-cn_topic_0240187365_section15406195619561"></a>

量化感知训练接口，根据用户最终的重训练好的模型，插入AscendQuant、AscendDequant等算子，生成最终量化精度仿真模型以及量化部署模型。

## 函数原型<a name="zh-cn_topic_0240187365_zh-cn_topic_0122830089_section428121323411"></a>

```python
save_quant_retrain_model (config_file, model, record_file, save_path,  input_data, input_names=None, output_names=None, dynamic_axes=None)
```

## 参数说明<a name="section73811524135618"></a>

<a name="zh-cn_topic_0240187365_zh-cn_topic_0122830089_table438764393513"></a>
<table><thead align="left"><tr id="zh-cn_topic_0240187365_zh-cn_topic_0122830089_row53871743113510"><th class="cellrowborder" valign="top" width="11.35%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0240187365_zh-cn_topic_0122830089_p1438834363520"><a name="zh-cn_topic_0240187365_zh-cn_topic_0122830089_p1438834363520"></a><a name="zh-cn_topic_0240187365_zh-cn_topic_0122830089_p1438834363520"></a>参数名</p>
</th>
<th class="cellrowborder" valign="top" width="9.33%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0240187365_p1769255516412"><a name="zh-cn_topic_0240187365_p1769255516412"></a><a name="zh-cn_topic_0240187365_p1769255516412"></a>输入/输出</p>
</th>
<th class="cellrowborder" valign="top" width="79.32000000000001%" id="mcps1.1.4.1.3"><p id="p14891104892614"><a name="p14891104892614"></a><a name="p14891104892614"></a>说明</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0240187365_zh-cn_topic_0122830089_row2038874343514"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p17702250135118"><a name="p17702250135118"></a><a name="p17702250135118"></a>config_file</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p170365015514"><a name="p170365015514"></a><a name="p170365015514"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p11668105412611"><a name="p11668105412611"></a><a name="p11668105412611"></a>含义：用户生成的量化感知训练配置文件，用于指定模型network中量化层的配置情况。</p>
<p id="p27038501514"><a name="p27038501514"></a><a name="p27038501514"></a>数据类型：string</p>
</td>
</tr>
<tr id="row148501718185117"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p15703125017513"><a name="p15703125017513"></a><a name="p15703125017513"></a>model</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p970311508516"><a name="p970311508516"></a><a name="p970311508516"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p72892446271"><a name="p72892446271"></a><a name="p72892446271"></a>含义：已进行量化感知训练后的量化模型。</p>
<p id="p157031950195111"><a name="p157031950195111"></a><a name="p157031950195111"></a>数据类型：torch.nn.Module</p>
</td>
</tr>
<tr id="row3887102315512"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p127036506519"><a name="p127036506519"></a><a name="p127036506519"></a>record_file</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p17035502517"><a name="p17035502517"></a><a name="p17035502517"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p37411454275"><a name="p37411454275"></a><a name="p37411454275"></a>含义：量化因子记录文件路径及名称。</p>
<p id="p9703195055110"><a name="p9703195055110"></a><a name="p9703195055110"></a>数据类型：string</p>
</td>
</tr>
<tr id="row588872319519"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p8703550155111"><a name="p8703550155111"></a><a name="p8703550155111"></a>save_path</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p177031550185118"><a name="p177031550185118"></a><a name="p177031550185118"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p189971465277"><a name="p189971465277"></a><a name="p189971465277"></a>含义：量化模型存放路径。该路径需要包含模型名前缀，例如./quantized_model/*model。</p>
<p id="p87041950175120"><a name="p87041950175120"></a><a name="p87041950175120"></a>数据类型：string</p>
</td>
</tr>
<tr id="row1739023214510"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p8704105085113"><a name="p8704105085113"></a><a name="p8704105085113"></a>input_data</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p3704135016518"><a name="p3704135016518"></a><a name="p3704135016518"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p426418480279"><a name="p426418480279"></a><a name="p426418480279"></a>含义：模型的输入数据。一个<span>torch.tensor</span><span>会被等价为tuple（torch.tensor）</span>。</p>
<p id="p37045500510"><a name="p37045500510"></a><a name="p37045500510"></a>数据类型：tuple</p>
</td>
</tr>
<tr id="row539163214513"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p37041850185117"><a name="p37041850185117"></a><a name="p37041850185117"></a>input_names</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p117041506519"><a name="p117041506519"></a><a name="p117041506519"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p18609049122716"><a name="p18609049122716"></a><a name="p18609049122716"></a>含义：模型的输入的名称，用于保存的量化onnx模型中显示。</p>
<p id="p4704195095118"><a name="p4704195095118"></a><a name="p4704195095118"></a>默认值：None</p>
<p id="p14704850115116"><a name="p14704850115116"></a><a name="p14704850115116"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row1391532115114"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p107040501510"><a name="p107040501510"></a><a name="p107040501510"></a>output_names</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p16705195017512"><a name="p16705195017512"></a><a name="p16705195017512"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p12926523273"><a name="p12926523273"></a><a name="p12926523273"></a>含义：模型的输出的名称，用于保存的量化onnx模型中显示。</p>
<p id="p147058501513"><a name="p147058501513"></a><a name="p147058501513"></a>默认值：None</p>
<p id="p170525018516"><a name="p170525018516"></a><a name="p170525018516"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row1021713282517"><td class="cellrowborder" valign="top" width="11.35%" headers="mcps1.1.4.1.1 "><p id="p1705195075116"><a name="p1705195075116"></a><a name="p1705195075116"></a>dynamic_axes</p>
</td>
<td class="cellrowborder" valign="top" width="9.33%" headers="mcps1.1.4.1.2 "><p id="p117054506516"><a name="p117054506516"></a><a name="p117054506516"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.32000000000001%" headers="mcps1.1.4.1.3 "><p id="p13724125717271"><a name="p13724125717271"></a><a name="p13724125717271"></a>含义：对模型输入输出动态轴的指定，例如对于输入inputs（NCHW），N、H、W为不确定大小，输出outputs（NL），N为不确定大小，则指定形式为：</p>
<p id="p064281193019"><a name="p064281193019"></a><a name="p064281193019"></a>{"inputs": [0,2,3], "outputs": [0]}，其中0,2,3分别表示N，H，W所在位置的索引。</p>
<p id="p17705165016517"><a name="p17705165016517"></a><a name="p17705165016517"></a>默认值：None</p>
<p id="p270525085117"><a name="p270525085117"></a><a name="p270525085117"></a>数据类型：dict&lt;string, dict&lt;python:int, string&gt;&gt; or dict&lt;string, list(int)<em id="i17705135016515"><a name="i17705135016515"></a><a name="i17705135016515"></a>&gt;</em></p>
<p id="p4451162412318"><a name="p4451162412318"></a><a name="p4451162412318"></a>使用约束：int类型取值需要为非负数</p>
</td>
</tr>
</tbody>
</table>

## 返回值说明<a name="zh-cn_topic_0240188739_zh-cn_topic_0122830089_section293415513458"></a>

无

## 调用示例<a name="zh-cn_topic_0240188739_section64231658994"></a>

```python
import amct_pytorch as amct
# 建立待量化的网络图结构
model = build_model()
model.load_state_dict(torch.load(state_dict_path))
input_data = tuple([torch.randn(input_shape)])
# 训练量化retrain模型，训练量化因子
train_model(quant_retrain_model, input_batch)
# 推理量化retrain模型，导出量化因子
infer_model(quant_retrain_model, input_batch)
 
# 插入量化API，将量化感知训练的模型存为ONNX文件
amct.save_quant_retrain_model(
               config_json_file,
               model, 
               record_file,
               save_path="./results/model"
               input_data,
               input_names=['input'],
               output_names=['output'],
               dynamic_axes={'input':{0: 'batch_size'},
                             'output':{0: 'batch_size'}})
```

落盘文件说明：

-   精度仿真模型文件：ONNX格式的模型文件，模型名中包含fake\_quant，可以在ONNX Runtime环境进行精度仿真。
-   部署模型文件：ONNX格式的模型文件，模型名中包含deploy，经过ATC转换工具转换后可部署到AI处理器。
-   （可选）\*.external文件，包括\*deploy.external和\*fakequant.external：

    只有保存的精度仿真模型以及部署模型文件大小\>=2GB才会生成该类文件，且与压缩后的\*.onnx模型文件生成在同级目录，用于保存Tensor中的数据，每个Tensor数据单独保存一份\*.external文件，文件名与Tensor相同，例如_conv1.weight_\_deploy.external和_conv1.weight_\_fakequant.external。

    后续通过ATC工具加载压缩后的\*.onnx部署模型文件进行模型转换时，会自动读取同级目录下\*.external文件中的Tensor数据。

重新执行量化感知训练时，该接口输出的上述文件将会被覆盖。

