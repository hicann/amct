# save\_prune\_retrain\_model<a name="ZH-CN_TOPIC_0000002548788567"></a>

## 产品支持情况<a name="section18210163319189"></a>

<a name="zh-cn_topic_0000002548668559_table38301303189"></a>
<table><thead align="left"><tr id="zh-cn_topic_0000002548668559_row20831180131817"><th class="cellrowborder" valign="top" width="57.99999999999999%" id="mcps1.1.3.1.1"><p id="zh-cn_topic_0000002548668559_p1883113061818"><a name="zh-cn_topic_0000002548668559_p1883113061818"></a><a name="zh-cn_topic_0000002548668559_p1883113061818"></a><span id="zh-cn_topic_0000002548668559_ph20833205312295"><a name="zh-cn_topic_0000002548668559_ph20833205312295"></a><a name="zh-cn_topic_0000002548668559_ph20833205312295"></a>产品</span></p>
</th>
<th class="cellrowborder" align="left" valign="top" width="42%" id="mcps1.1.3.1.2"><p id="zh-cn_topic_0000002548668559_p783113012187"><a name="zh-cn_topic_0000002548668559_p783113012187"></a><a name="zh-cn_topic_0000002548668559_p783113012187"></a>是否支持</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0000002548668559_row574891710101"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002548668559_p177491117171015"><a name="zh-cn_topic_0000002548668559_p177491117171015"></a><a name="zh-cn_topic_0000002548668559_p177491117171015"></a><span id="zh-cn_topic_0000002548668559_ph2272194216543"><a name="zh-cn_topic_0000002548668559_ph2272194216543"></a><a name="zh-cn_topic_0000002548668559_ph2272194216543"></a>Ascend 950PR/Ascend 950DT</span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="42%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002548668559_ul1367712433612"></a><a name="zh-cn_topic_0000002548668559_ul1367712433612"></a><ul id="zh-cn_topic_0000002548668559_ul1367712433612"><li>通道稀疏：√</li><li>4选2结构化稀疏接口：x</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002548668559_row220181016240"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002548668559_p48327011813"><a name="zh-cn_topic_0000002548668559_p48327011813"></a><a name="zh-cn_topic_0000002548668559_p48327011813"></a><span id="zh-cn_topic_0000002548668559_ph583230201815"><a name="zh-cn_topic_0000002548668559_ph583230201815"></a><a name="zh-cn_topic_0000002548668559_ph583230201815"></a><term id="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term1253731311225"><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term1253731311225"></a><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term1253731311225"></a>Atlas A3 训练系列产品</term>/<term id="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term131434243115"><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term131434243115"></a><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term131434243115"></a>Atlas A3 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="42%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002548668559_ul66191179379"></a><a name="zh-cn_topic_0000002548668559_ul66191179379"></a><ul id="zh-cn_topic_0000002548668559_ul66191179379"><li>通道稀疏：√</li><li>4选2结构化稀疏接口：√</li></ul>
</td>
</tr>
<tr id="zh-cn_topic_0000002548668559_row173226882415"><td class="cellrowborder" valign="top" width="57.99999999999999%" headers="mcps1.1.3.1.1 "><p id="zh-cn_topic_0000002548668559_p14832120181815"><a name="zh-cn_topic_0000002548668559_p14832120181815"></a><a name="zh-cn_topic_0000002548668559_p14832120181815"></a><span id="zh-cn_topic_0000002548668559_ph1483216010188"><a name="zh-cn_topic_0000002548668559_ph1483216010188"></a><a name="zh-cn_topic_0000002548668559_ph1483216010188"></a><term id="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term11962195213215"><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term11962195213215"></a><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term11962195213215"></a>Atlas A2 训练系列产品</term>/<term id="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term184716139811"><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term184716139811"></a><a name="zh-cn_topic_0000002548668559_zh-cn_topic_0000001312391781_term184716139811"></a>Atlas A2 推理系列产品</term></span></p>
</td>
<td class="cellrowborder" align="left" valign="top" width="42%" headers="mcps1.1.3.1.2 "><a name="zh-cn_topic_0000002548668559_ul19623147153713"></a><a name="zh-cn_topic_0000002548668559_ul19623147153713"></a><ul id="zh-cn_topic_0000002548668559_ul19623147153713"><li>通道稀疏：√</li><li>4选2结构化稀疏接口：√</li></ul>
</td>
</tr>
</tbody>
</table>

**注：上述4选2结构化稀疏特性，标记“x”的产品，调用接口不会报错，但是获取不到性能收益。**

## 功能说明<a name="section139511944317"></a>

稀疏接口，根据用户最终的重训练好的稀疏模型，生成最终ONNX仿真模型以及部署模型。

## 约束说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_section1443392021419"></a>

针对稀疏模型，通过该接口生成的两个文件为直接使用PyTorch导出的ONNX文件，文件内容一致，文件名称分别包括deploy和fake\_quant关键字。

## 函数原型<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section428121323411"></a>

```python
save_prune_retrain_model(model, save_path, input_data, input_names=None, output_names=None, dynamic_axes=None)
```

## 参数说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section795991810344"></a>

<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_table438764393513"></a>
<table><thead align="left"><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row53871743113510"><th class="cellrowborder" valign="top" width="12.35%" id="mcps1.1.4.1.1"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_p1438834363520"></a>参数名</p>
</th>
<th class="cellrowborder" valign="top" width="7.670000000000001%" id="mcps1.1.4.1.2"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p1769255516412"></a>输入/输出</p>
</th>
<th class="cellrowborder" valign="top" width="79.97999999999999%" id="mcps1.1.4.1.3"><p id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a><a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_p15231205416325"></a>说明</p>
</th>
</tr>
</thead>
<tbody><tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_row2038874343514"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p12108101818814"><a name="p12108101818814"></a><a name="p12108101818814"></a>model</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p13482131324113"><a name="p13482131324113"></a><a name="p13482131324113"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p17691129844"><a name="p17691129844"></a><a name="p17691129844"></a>含义：已经进行稀疏后的PyTorch模型。</p>
<p id="p9607425115012"><a name="p9607425115012"></a><a name="p9607425115012"></a>数据类型：torch.nn.Module</p>
</td>
</tr>
<tr id="zh-cn_topic_0254208276_zh-cn_topic_0240188739_row2997141123911"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p1110815181988"><a name="p1110815181988"></a><a name="p1110815181988"></a>save_path</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p141811497475"><a name="p141811497475"></a><a name="p141811497475"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p154071639641"><a name="p154071639641"></a><a name="p154071639641"></a>含义：保存压缩模型的路径。该路径需要包含模型名前缀，例如./prune_model/*model。</p>
<p id="p3624142513506"><a name="p3624142513506"></a><a name="p3624142513506"></a>数据类型：string</p>
</td>
</tr>
<tr id="row51780230810"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p017819231680"><a name="p017819231680"></a><a name="p017819231680"></a>input_data</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p61604531884"><a name="p61604531884"></a><a name="p61604531884"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p1666617401442"><a name="p1666617401442"></a><a name="p1666617401442"></a>含义：模型的输入数据。一个<span>torch.tensor</span><span>会被等价为tuple（torch.tensor）</span>。</p>
<p id="p195118591985"><a name="p195118591985"></a><a name="p195118591985"></a>数据类型：tuple</p>
</td>
</tr>
<tr id="row161899281186"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p1810815183816"><a name="p1810815183816"></a><a name="p1810815183816"></a>input_names</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p1817012537814"><a name="p1817012537814"></a><a name="p1817012537814"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p39306411349"><a name="p39306411349"></a><a name="p39306411349"></a>含义：模型的输入名称，用于保存的稀疏ONNX模型中显示。</p>
<p id="p78101226135"><a name="p78101226135"></a><a name="p78101226135"></a>默认值：None</p>
<p id="p1451615598811"><a name="p1451615598811"></a><a name="p1451615598811"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row9693030189"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p18108718889"><a name="p18108718889"></a><a name="p18108718889"></a>output_names</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p91791053686"><a name="p91791053686"></a><a name="p91791053686"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p512224319414"><a name="p512224319414"></a><a name="p512224319414"></a>含义：模型的输出名称，用于保存的稀疏ONNX模型中显示。</p>
<p id="p1631083319133"><a name="p1631083319133"></a><a name="p1631083319133"></a>默认值：None</p>
<p id="p115239594818"><a name="p115239594818"></a><a name="p115239594818"></a>数据类型：list(string)</p>
</td>
</tr>
<tr id="row127516261687"><td class="cellrowborder" valign="top" width="12.35%" headers="mcps1.1.4.1.1 "><p id="p5275326787"><a name="p5275326787"></a><a name="p5275326787"></a>dynamic_axes</p>
</td>
<td class="cellrowborder" valign="top" width="7.670000000000001%" headers="mcps1.1.4.1.2 "><p id="p10185135316819"><a name="p10185135316819"></a><a name="p10185135316819"></a>输入</p>
</td>
<td class="cellrowborder" valign="top" width="79.97999999999999%" headers="mcps1.1.4.1.3 "><p id="p164697449419"><a name="p164697449419"></a><a name="p164697449419"></a>含义：对模型输入输出动态轴的指定，例如对于输入inputs（NCHW），N、H、W为不确定大小，输出outputs（NL），N为不确定大小，则指定形式为：</p>
<p id="p1217918111059"><a name="p1217918111059"></a><a name="p1217918111059"></a>{ "inputs": [0,2,3], "outputs": [0]}，其中0,2,3分别表示N，H，W所在位置的索引。</p>
<p id="p1460565011316"><a name="p1460565011316"></a><a name="p1460565011316"></a>默认值：None</p>
<p id="p460555021319"><a name="p460555021319"></a><a name="p460555021319"></a>数据类型：dict&lt;string, dict&lt;python:int, string&gt;&gt; or dict&lt;string, list(int)&gt;</p>
</td>
</tr>
</tbody>
</table>

## 返回值说明<a name="zh-cn_topic_0254208276_zh-cn_topic_0240188739_zh-cn_topic_0122830089_section293415513458"></a>

无

## 调用示例<a name="zh-cn_topic_0254208276_section213682915617"></a>

```python
import amct_pytorch as amct
# 建立待压缩的网络图结构
model = build_model()

# create selective prune model

#训练retrain模型，训练量化因子
train(pruned_retrain_model)
infer(pruned_retrain_model)

input_data = tuple([torch.randn(input_shape)])
save_path = os.path.join(OUTPUTS_DIR, 'custom_name')

#插入保存组合压缩模型的API，转换成ONNX文件
amct.save_prune_retrain_model(
     pruned_retrain_model,
     save_path,
     input_data,
     input_names=['input'],
     output_names=['output'],
     dynamic_axes={'input':{0:'batch_size'}, 'output':{0:'batch_size'}})
```

落盘文件说明：

-   精度仿真模型文件：ONNX格式的模型文件，模型名中包含fake\_quant，可以在ONNX Runtime环境进行精度仿真。
-   部署模型文件：ONNX格式的模型文件，模型名中包含deploy，经过ATC转换工具转换后可部署到AI处理器。
-   （可选）external data文件，稀疏特性不区分\*deploy.external和\*fakequant.external文件：

    只有保存的精度仿真模型以及部署模型文件大小\>=2GB才会生成该类文件，且与压缩后的\*.onnx文件生成在同级目录，用于保存Tensor中的数据，每个Tensor数据单独保存一个文件，文件名与Tensor相同，例如conv\_1.weight。

    后续通过ATC工具加载压缩后的\*.onnx部署模型文件进行模型转换时，会自动读取同级目录下external data文件中的Tensor数据。

重新执行稀疏特性时，该接口输出的上述文件将会被覆盖。

